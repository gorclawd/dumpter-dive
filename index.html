<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üóëÔ∏è Dumpster Dive | Gorbagana</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            padding: 20px;
            padding-top: 80px;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        .logo { font-size: 1.3em; font-weight: bold; }
        .wallet-section { display: flex; align-items: center; gap: 15px; }
        .balance {
            background: linear-gradient(145deg, #2a2a3a, #1a1a2a);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            color: #00ff88;
            cursor: pointer;
        }
        .balance:hover { background: linear-gradient(145deg, #3a3a4a, #2a2a3a); }
        .connect-btn {
            background: linear-gradient(145deg, #e33e3e, #c73535);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .connect-btn:hover { transform: scale(1.05); box-shadow: 0 5px 20px rgba(227, 62, 62, 0.4); }
        .connect-btn.connected { background: linear-gradient(145deg, #00ff88, #00cc6a); color: #000; }
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            margin-top: 20px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        .subtitle {
            color: #888;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .network-badge {
            background: linear-gradient(145deg, #ff6b35, #f7931a);
            color: #000;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .bet-section {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .bet-btn {
            background: linear-gradient(145deg, #2d2d2d, #1a1a1a);
            color: #fff;
            border: 2px solid #333;
            padding: 12px 24px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        .bet-btn:hover:not(:disabled) { border-color: #00ff88; transform: translateY(-2px); }
        .bet-btn.selected { border-color: #00ff88; background: linear-gradient(145deg, #1a4d2e, #0d2818); }
        .bet-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .current-bet {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #ffaa00;
        }
        .game-area {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .trash-bag {
            width: 120px;
            height: 150px;
            background: linear-gradient(145deg, #2d2d2d, #1a1a1a);
            border-radius: 20px 20px 30px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            border: 3px solid #333;
            position: relative;
            overflow: hidden;
        }
        .trash-bag:hover:not(.revealed):not(.disabled) {
            transform: translateY(-10px) scale(1.05);
            border-color: #00ff88;
            box-shadow: 0 20px 40px rgba(0, 255, 136, 0.3);
        }
        .trash-bag.revealed, .trash-bag.disabled { cursor: default; }
        .trash-bag.disabled { opacity: 0.5; }
        .trash-bag.winner {
            background: linear-gradient(145deg, #1a4d2e, #0d2818);
            border-color: #00ff88;
            animation: pulse 0.5s ease;
        }
        .trash-bag.loser {
            background: linear-gradient(145deg, #4d1a1a, #280d0d);
            border-color: #ff4444;
            opacity: 0.7;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .result {
            font-size: 1.8em;
            min-height: 50px;
            text-align: center;
            margin-bottom: 15px;
        }
        .result.win { color: #00ff88; text-shadow: 0 0 20px rgba(0, 255, 136, 0.8); }
        .result.lose { color: #ff4444; }
        .payout { font-size: 1.2em; color: #ffaa00; margin-bottom: 20px; }
        .stats {
            display: flex;
            gap: 30px;
            margin-bottom: 25px;
            font-size: 1.1em;
        }
        .stat { text-align: center; }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #00ff88;
        }
        .stat-label { color: #666; font-size: 0.8em; }
        button.play-btn {
            background: linear-gradient(145deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button.play-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4);
        }
        button.play-btn:disabled {
            background: #333;
            color: #666;
            cursor: default;
            transform: none;
            box-shadow: none;
        }
        .footer {
            position: fixed;
            bottom: 20px;
            color: #444;
            font-size: 0.9em;
        }
        .footer a { color: #00ff88; text-decoration: none; }
        .streak { color: #ffaa00; font-size: 0.9em; margin-top: 10px; }
        .multiplier-info {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid rgba(255, 170, 0, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        .house-edge { color: #666; font-size: 0.85em; margin-top: 5px; }
        .leaderboard {
            margin-top: 40px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
        }
        .leaderboard h3 { margin-bottom: 15px; color: #ffaa00; }
        .lb-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        .lb-row:last-child { border-bottom: none; }
        .lb-rank { color: #666; width: 30px; }
        .lb-addr { color: #888; font-family: monospace; }
        .lb-profit { color: #00ff88; font-weight: bold; }
        .lb-profit.negative { color: #ff4444; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: linear-gradient(145deg, #2a2a3a, #1a1a2a);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .modal-content h2 { margin-bottom: 20px; }
        .modal-content p { color: #888; margin-bottom: 20px; }
        .deposit-addr {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.85em;
            cursor: pointer;
            border: 2px solid #333;
            transition: all 0.3s;
        }
        .deposit-addr:hover { border-color: #00ff88; }
        .copied { border-color: #00ff88 !important; }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        .btn-row button { flex: 1; }
        .withdraw-input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #1a1a1a;
            color: #fff;
            font-size: 1em;
            margin-bottom: 15px;
            text-align: center;
        }
        .withdraw-input:focus { border-color: #00ff88; outline: none; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: #ff4444; font-size: 0.9em; margin-top: 10px; }
        .success-msg { color: #00ff88; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üóëÔ∏è Dumpster Dive</div>
        <div class="wallet-section">
            <div class="balance" id="balanceDisplay" style="display:none;" onclick="showBalanceModal()">
                <span id="gorBalance">0</span> $GOR
            </div>
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect Backpack</button>
        </div>
    </div>

    <h1>üóëÔ∏è Dumpster Dive</h1>
    <p class="subtitle">Pick a bag. One has treasure. Win 2x your bet!</p>
    <div class="network-badge">üóëÔ∏è GORBAGANA CHAIN</div>
    
    <div class="multiplier-info">
        üé∞ Win = <strong>2x payout</strong> | 33% chance | House edge: 33%
        <div class="house-edge">50% of house profits go to $GOR buyback & burn üî•</div>
    </div>

    <div class="bet-section" id="betSection">
        <button class="bet-btn" data-amount="10" onclick="selectBet(10)">10 GOR</button>
        <button class="bet-btn" data-amount="50" onclick="selectBet(50)">50 GOR</button>
        <button class="bet-btn" data-amount="100" onclick="selectBet(100)">100 GOR</button>
        <button class="bet-btn" data-amount="500" onclick="selectBet(500)">500 GOR</button>
        <button class="bet-btn" data-amount="1000" onclick="selectBet(1000)">1K GOR</button>
    </div>

    <div class="current-bet" id="currentBet">Select bet amount</div>

    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="wins">0</div>
            <div class="stat-label">WINS</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="losses">0</div>
            <div class="stat-label">LOSSES</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="wagered">0</div>
            <div class="stat-label">WAGERED</div>
        </div>
    </div>
    
    <div class="game-area" id="game">
        <div class="trash-bag disabled" data-bag="0">üóëÔ∏è</div>
        <div class="trash-bag disabled" data-bag="1">üóëÔ∏è</div>
        <div class="trash-bag disabled" data-bag="2">üóëÔ∏è</div>
    </div>
    
    <div class="result" id="result"></div>
    <div class="payout" id="payout"></div>
    <div class="streak" id="streak"></div>
    
    <button class="play-btn" id="playBtn" onclick="startRound()" disabled>Connect Wallet to Play</button>

    <div class="leaderboard" id="leaderboard">
        <h3>üèÜ Top Degens</h3>
        <div id="lbContent">Loading...</div>
    </div>
    
    <div class="footer">
        Built by <a href="https://t.me/gorbro" target="_blank">gorbro</a> on Gorbagana üóëÔ∏è
    </div>

    <!-- Deposit Modal -->
    <div class="modal" id="depositModal">
        <div class="modal-content">
            <h2>üí∞ Deposit $GOR</h2>
            <p>Send GOR to the house wallet to play</p>
            <div style="font-size:0.8em;color:#666;margin-bottom:5px;">House Wallet (click to copy):</div>
            <div class="deposit-addr" id="houseAddr" onclick="copyAddr()">Loading...</div>
            <p style="font-size:0.85em;">Min deposit: 10 GOR</p>
            <div class="btn-row">
                <button class="bet-btn" onclick="checkBalance()">Check Balance</button>
                <button class="bet-btn" onclick="closeModal('depositModal')">Close</button>
            </div>
            <div id="depositMsg"></div>
        </div>
    </div>

    <!-- Balance Modal -->
    <div class="modal" id="balanceModal">
        <div class="modal-content">
            <h2>üí∞ Your Balance</h2>
            <div style="font-size:2.5em;color:#00ff88;margin:20px 0;" id="balanceModalAmount">0 GOR</div>
            <div class="btn-row">
                <button class="connect-btn" onclick="showDepositModal()">Deposit</button>
                <button class="connect-btn" style="background:linear-gradient(145deg,#ff6b35,#f7931a);" onclick="showWithdrawModal()">Withdraw</button>
            </div>
            <button class="bet-btn" style="width:100%;margin-top:15px;" onclick="closeModal('balanceModal')">Close</button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <h2>üí∏ Withdraw $GOR</h2>
            <p>Available: <span id="withdrawAvailable">0</span> GOR</p>
            <input type="number" class="withdraw-input" id="withdrawAmount" placeholder="Amount to withdraw">
            <button class="bet-btn" style="width:100%;margin-bottom:10px;" onclick="withdrawMax()">Withdraw Max</button>
            <div class="btn-row">
                <button class="connect-btn" onclick="doWithdraw()">Withdraw</button>
                <button class="bet-btn" onclick="closeModal('withdrawModal')">Cancel</button>
            </div>
            <div id="withdrawMsg"></div>
        </div>
    </div>

    <script>
        // Config - Update this to your server URL
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3001' 
            : 'https://dumpster-api.gorbagana.xyz'; // Update when deployed
        const GOR_DECIMALS = 9;
        const LAMPORTS_PER_GOR = 10 ** GOR_DECIMALS;
        const MULTIPLIER = 2;

        // State
        let wallet = null;
        let balance = 0;
        let selectedBet = 0;
        let gameActive = false;
        let houseWallet = '';

        const prizes = ['üíé', 'ü™ô', 'üí∞', 'üèÜ', '‚≠ê'];
        const trash = ['ü¶¥', 'üçå', 'üßª', 'ü™≥', 'üíÄ'];

        // Init
        async function init() {
            try {
                const res = await fetch(`${API_URL}/api/house`);
                const data = await res.json();
                houseWallet = data.wallet;
                document.getElementById('houseAddr').textContent = houseWallet;
            } catch (e) {
                console.error('Failed to get house wallet:', e);
            }
            loadLeaderboard();
        }

        async function connectWallet() {
            // Check for Backpack
            if (window.backpack) {
                try {
                    await window.backpack.connect();
                    wallet = window.backpack.publicKey.toString();
                    onWalletConnected();
                } catch (err) {
                    console.error('Backpack error:', err);
                }
            } 
            // Fallback to Phantom
            else if (window.solana && window.solana.isPhantom) {
                try {
                    const resp = await window.solana.connect();
                    wallet = resp.publicKey.toString();
                    onWalletConnected();
                } catch (err) {
                    console.error('Phantom error:', err);
                }
            }
            // Fallback to Solflare
            else if (window.solflare) {
                try {
                    await window.solflare.connect();
                    wallet = window.solflare.publicKey.toString();
                    onWalletConnected();
                } catch (err) {
                    console.error('Solflare error:', err);
                }
            }
            else {
                window.open('https://www.backpack.app/', '_blank');
            }
        }

        async function onWalletConnected() {
            document.getElementById('connectBtn').textContent = wallet.slice(0,4) + '...' + wallet.slice(-4);
            document.getElementById('connectBtn').classList.add('connected');
            document.getElementById('balanceDisplay').style.display = 'block';
            document.getElementById('playBtn').textContent = 'SELECT BET';
            await checkBalance();
        }

        async function checkBalance() {
            if (!wallet) return;
            try {
                document.getElementById('depositMsg').innerHTML = '<div class="loading"></div>';
                const res = await fetch(`${API_URL}/api/balance?wallet=${wallet}`);
                const data = await res.json();
                balance = data.balance;
                updateBalanceDisplay();
                document.getElementById('depositMsg').innerHTML = '<div class="success-msg">Balance updated!</div>';
            } catch (e) {
                document.getElementById('depositMsg').innerHTML = '<div class="error-msg">Failed to check balance</div>';
            }
        }

        function updateBalanceDisplay() {
            const gorBalance = Math.floor(balance / LAMPORTS_PER_GOR);
            document.getElementById('gorBalance').textContent = gorBalance;
            document.getElementById('balanceModalAmount').textContent = gorBalance + ' GOR';
            document.getElementById('withdrawAvailable').textContent = gorBalance;
            
            if (balance > 0) {
                document.getElementById('playBtn').disabled = false;
            }
        }

        function selectBet(amount) {
            if (!wallet) {
                connectWallet();
                return;
            }
            const amountLamports = amount * LAMPORTS_PER_GOR;
            if (amountLamports > balance) {
                showDepositModal();
                return;
            }
            selectedBet = amountLamports;
            document.querySelectorAll('.bet-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.amount) === amount);
            });
            document.getElementById('currentBet').textContent = `Bet: ${amount} GOR ‚Üí Win: ${amount * MULTIPLIER} GOR`;
            document.getElementById('playBtn').disabled = false;
            document.getElementById('playBtn').textContent = `DIVE FOR ${amount} GOR`;
        }

        function startRound() {
            if (!wallet || selectedBet === 0 || selectedBet > balance) return;
            
            gameActive = true;
            document.getElementById('result').textContent = '';
            document.getElementById('result').className = 'result';
            document.getElementById('payout').textContent = '';
            document.getElementById('playBtn').disabled = true;
            document.getElementById('playBtn').textContent = 'Pick a bag...';
            
            enableBags(true);
        }

        function enableBags(enabled) {
            document.querySelectorAll('.trash-bag').forEach((bag, i) => {
                bag.className = 'trash-bag' + (enabled ? '' : ' disabled');
                bag.textContent = 'üóëÔ∏è';
                if (enabled) {
                    bag.onclick = () => pickBag(i);
                } else {
                    bag.onclick = null;
                }
            });
        }

        async function pickBag(index) {
            if (!gameActive) return;
            gameActive = false;
            
            document.getElementById('playBtn').innerHTML = '<div class="loading"></div>';
            
            try {
                const res = await fetch(`${API_URL}/api/play`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet,
                        betAmount: selectedBet,
                        chosenBag: index
                    })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('result').textContent = data.error;
                    document.getElementById('result').className = 'result lose';
                    document.getElementById('playBtn').disabled = false;
                    document.getElementById('playBtn').textContent = 'TRY AGAIN';
                    return;
                }
                
                // Update balance
                balance = data.newBalance;
                updateBalanceDisplay();
                
                // Show result
                const bags = document.querySelectorAll('.trash-bag');
                bags.forEach((bag, i) => {
                    bag.classList.add('revealed');
                    if (i === data.winningBag) {
                        bag.classList.add('winner');
                        bag.textContent = prizes[Math.floor(Math.random() * prizes.length)];
                    } else {
                        bag.classList.add('loser');
                        bag.textContent = trash[Math.floor(Math.random() * trash.length)];
                    }
                    bag.onclick = null;
                });
                
                const result = document.getElementById('result');
                const payout = document.getElementById('payout');
                
                if (data.won) {
                    result.textContent = 'üéâ TREASURE FOUND!';
                    result.className = 'result win';
                    payout.textContent = `+${data.payout / LAMPORTS_PER_GOR} GOR`;
                    payout.style.color = '#00ff88';
                } else {
                    result.textContent = 'üíÄ Just trash...';
                    result.className = 'result lose';
                    payout.textContent = `-${selectedBet / LAMPORTS_PER_GOR} GOR`;
                    payout.style.color = '#ff4444';
                }
                
                // Update stats
                if (data.stats) {
                    document.getElementById('wins').textContent = data.stats.wins || 0;
                    document.getElementById('losses').textContent = data.stats.losses || 0;
                    document.getElementById('wagered').textContent = Math.floor((data.stats.wagered || 0) / LAMPORTS_PER_GOR);
                }
                
                loadLeaderboard();
                
            } catch (e) {
                document.getElementById('result').textContent = 'Network error. Try again.';
                document.getElementById('result').className = 'result lose';
            }
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('playBtn').textContent = 'DIVE AGAIN';
        }

        async function doWithdraw() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            if (!amount || amount < 10) {
                document.getElementById('withdrawMsg').innerHTML = '<div class="error-msg">Min withdrawal: 10 GOR</div>';
                return;
            }
            
            const amountLamports = Math.floor(amount * LAMPORTS_PER_GOR);
            if (amountLamports > balance) {
                document.getElementById('withdrawMsg').innerHTML = '<div class="error-msg">Insufficient balance</div>';
                return;
            }
            
            document.getElementById('withdrawMsg').innerHTML = '<div class="loading"></div>';
            
            try {
                const res = await fetch(`${API_URL}/api/withdraw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet, amount: amountLamports })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('withdrawMsg').innerHTML = `<div class="error-msg">${data.error}</div>`;
                    return;
                }
                
                balance = data.newBalance;
                updateBalanceDisplay();
                document.getElementById('withdrawMsg').innerHTML = `<div class="success-msg">Withdrawn! TX: ${data.signature.slice(0,8)}...</div>`;
                document.getElementById('withdrawAmount').value = '';
                
            } catch (e) {
                document.getElementById('withdrawMsg').innerHTML = '<div class="error-msg">Withdrawal failed</div>';
            }
        }

        function withdrawMax() {
            const maxGor = Math.floor(balance / LAMPORTS_PER_GOR);
            document.getElementById('withdrawAmount').value = maxGor;
        }

        async function loadLeaderboard() {
            try {
                const res = await fetch(`${API_URL}/api/leaderboard`);
                const data = await res.json();
                
                if (!data.leaderboard || data.leaderboard.length === 0) {
                    document.getElementById('lbContent').innerHTML = '<div style="color:#666">No players yet. Be the first!</div>';
                    return;
                }
                
                let html = '';
                data.leaderboard.forEach((p, i) => {
                    const wageredGor = Math.floor(p.wagered / LAMPORTS_PER_GOR);
                    html += `<div class="lb-row">
                        <span class="lb-rank">#${i+1}</span>
                        <span class="lb-addr">${p.wallet}</span>
                        <span class="lb-profit">${wageredGor} GOR</span>
                    </div>`;
                });
                document.getElementById('lbContent').innerHTML = html;
            } catch (e) {
                document.getElementById('lbContent').innerHTML = '<div style="color:#666">Failed to load</div>';
            }
        }

        function copyAddr() {
            navigator.clipboard.writeText(houseWallet);
            document.getElementById('houseAddr').classList.add('copied');
            setTimeout(() => document.getElementById('houseAddr').classList.remove('copied'), 1000);
        }

        function showDepositModal() {
            document.getElementById('depositModal').classList.add('show');
            document.getElementById('depositMsg').innerHTML = '';
        }

        function showBalanceModal() {
            document.getElementById('balanceModal').classList.add('show');
        }

        function showWithdrawModal() {
            closeModal('balanceModal');
            document.getElementById('withdrawModal').classList.add('show');
            document.getElementById('withdrawMsg').innerHTML = '';
            document.getElementById('withdrawAmount').value = '';
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(modal.id);
            });
        });

        // Init
        init();
    </script>
</body>
</html>
